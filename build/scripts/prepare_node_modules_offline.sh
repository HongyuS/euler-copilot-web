#!/bin/bash
# build/scripts/prepare_node_modules_offline.sh
# 用于在有网环境下准备 node_modules 和 pnpm 缓存，实现离线安装
# 用法：在有网环境下运行一次，生成 release/offline_node_modules.tar.gz 和 release/offline_pnpm_store.tar.gz

set -e

WORKDIR=$(cd "$(dirname "$0")/../.." && pwd)
cd "$WORKDIR"

RELEASE_DIR="$WORKDIR/release"
mkdir -p "$RELEASE_DIR"

# 1. 安装依赖
pnpm install

# 2. 打包 node_modules
if [ -d node_modules ]; then
    tar -czf "$RELEASE_DIR/offline_node_modules.tar.gz" node_modules
fi

# 3. 查找 pnpm store 路径
PNPM_STORE=$(pnpm store path)
if [ -d "$PNPM_STORE" ]; then
    tar -czf "$RELEASE_DIR/offline_pnpm_store.tar.gz" -C "$PNPM_STORE" .
fi

echo "已生成 $RELEASE_DIR/offline_node_modules.tar.gz 和 $RELEASE_DIR/offline_pnpm_store.tar.gz，可用于离线环境。"
